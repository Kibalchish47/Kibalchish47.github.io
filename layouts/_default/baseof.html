<!doctype html>
<html lang="{{ .Site.LanguageCode | default "en" }}" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        {{ if .IsHome }}
            {{ .Site.Title }}
        {{ else }}
            {{ .Title }} - {{ .Site.Title }}
        {{ end }}
    </title>

    {{ partialCached "css.html" . }}

    {{/* Your favicon link - re-add when ready */}}
    {{/* <link rel="icon" type="image/png" href="{{ "D2.png" | relURL }}" /> */}}

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    {{/* Combined font link is good. The separate Source Code Pro link below this was redundant. */}}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Source+Code+Pro:wght@400;500;700&display=swap" rel="stylesheet">

    {{ block "head_extra" . }}{{ end }}
</head>
{{/* Removed hardcoded test classes like bg-lime-400. Styling should come from your compiled main.css */}}
<body class="flex flex-col min-h-screen font-sans"> {{/* Base classes - main.css will apply theme bg/text colors */}}
    {{ partial "site-header.html" . }}

    <main class="container mx-auto px-6 py-8 flex-grow">
        {{ block "main" . }}
            {{ end }}
    </main>

    {{ partial "site-footer.html" . }}

    {{/* layouts/_default/baseof.html -- 'scripts_extra' block */}}
    {{ define "scripts_extra" }}
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const navLinks = document.querySelectorAll('header nav a.nav-link');
        const currentFullURL = window.location.href;
        // Construct the base URL for comparison, ensuring it ends with a slash
        let siteBaseURL = '{{ .Site.BaseURL | relLangURL }}';
        if (siteBaseURL.length > 0 && !siteBaseURL.endsWith('/')) {
            siteBaseURL += '/';
        }
        if (siteBaseURL === "") { // Handle case where BaseURL might be "/" or empty for root
            siteBaseURL = "/";
        }


        // Function to normalize paths for comparison
        const normalizePath = (pathInput) => {
            let path = pathInput;
            try {
                if (pathInput.startsWith('http')) {
                    path = new URL(pathInput).pathname;
                }
            } catch (e) { /* Not a full URL, proceed */ }

            // Remove base URL prefix if current site is in a subfolder
            // Only do this if siteBaseURL is more than just "/"
            if (siteBaseURL !== "/" && path.startsWith(siteBaseURL)) {
                path = path.substring(siteBaseURL.length -1); // Keep leading slash from path
            }

            path = path.startsWith('/') ? path : '/' + path; // Ensure leading slash
            if (path.length > 1 && path.endsWith('/')) {
                path = path.slice(0, -1); // Remove trailing slash for consistency
            }
            if (path === '') path = '/'; // Ensure root path is represented as '/'
            return path;
        };

        const normalizedCurrentPath = normalizePath(currentFullURL.split('#')[0].split('?')[0]);

        let bestMatchLink = null;
        let longestMatchLength = -1;

        navLinks.forEach(link => {
            link.classList.remove('active', 'text-custom-red-500', 'bg-custom-red-200', 'font-semibold');
            link.classList.add('text-custom-gray-700');

            const linkHref = link.getAttribute('href');
            if (!linkHref) return;

            const normalizedLinkPath = normalizePath(linkHref);

            if (normalizedCurrentPath === normalizedLinkPath) { // Exact match takes precedence
                if (normalizedLinkPath.length >= longestMatchLength) { // Allow exact root match
                    longestMatchLength = normalizedLinkPath.length;
                    bestMatchLink = link;
                }
            } else if (normalizedLinkPath !== '/' && normalizedCurrentPath.startsWith(normalizedLinkPath + '/')) {
                // Sub-path match (e.g., /blog for /blog/post)
                if (normalizedLinkPath.length > longestMatchLength) {
                    longestMatchLength = normalizedLinkPath.length;
                    bestMatchLink = link;
                }
            }
        });

        if (bestMatchLink) {
            bestMatchLink.classList.add('active', 'text-custom-red-500', 'bg-custom-red-200', 'font-semibold');
            bestMatchLink.classList.remove('text-custom-gray-700');
        } else if (normalizedCurrentPath === '/') {
             // Explicitly activate "Homepage" link if we are on the root path and no other more specific link matched
            const homePageLink = document.querySelector('header nav a.nav-link[href$="/"]'); // Finds a link ending with /
             if (homePageLink && normalizePath(homePageLink.getAttribute('href')) === '/') {
                homePageLink.classList.add('active', 'text-custom-red-500', 'bg-custom-red-200', 'font-semibold');
                homePageLink.classList.remove('text-custom-gray-700');
             }
        }
    });
    </script>
    {{ end }}
</body>
</html>
